<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Counsellors</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans antialiased">
  <div class="flex min-h-screen">
    <%- include("../partials/navbar") %>

    <!-- Main Content -->
    <main class="flex-1 p-8 ml-64 bg-gray-100">

      <!-- Success/Error Notifications -->
      <% if (typeof success !== 'undefined' && success) { %>
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-6 flex items-center">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          <span class="font-medium">Success!</span>
          <span class="ml-2"><%= success %></span>
        </div>
      <% } %>

      <!-- Header -->
      <section class="bg-white p-6 rounded-2xl shadow-md mb-8 border border-gray-200">
        <h1 class="text-3xl font-extrabold text-gray-900">Available Counsellors</h1>
        <p class="text-gray-600 mt-1">Choose a slot and book your counsellor</p>
        
        <!-- Date Selector -->
        <div class="mt-4">
          <label for="date" class="block text-sm font-medium text-gray-700 mb-2">Select Date:</label>
          <input type="date" 
                 id="date" 
                 name="date" 
                 value="<%= selectedDate %>"
                 class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                 onchange="window.location.href='/counsellors?date=' + this.value">
          <p class="text-sm text-gray-600 mt-1">Selected: <%= new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></p>
        </div>
      </section>

      <!-- Counsellor List -->
      <% if (counsellors && counsellors.length > 0) { %>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <% counsellors.forEach(c => { %>
            <% 
              const counsellorBookedSlots = bookedSlots[c._id.toString()] || new Set();
              const userBookedSlots = userBookings.filter(b => b.counsellor._id.toString() === c._id.toString()).map(b => b.slot);
              
              // Get available slots for the selected day
              const availableSlotsForDay = c.weeklySchedule?.[dayOfWeek] || [];
              const hasAvailableSlots = availableSlotsForDay.length > 0;
            %>
            <div class="bg-white border border-gray-200 rounded-2xl shadow-sm hover:shadow-lg transition p-6 flex flex-col">

              <!-- Counsellor Info -->
              <div class="mb-4">
                <h3 class="text-xl font-bold text-gray-800 mb-1"><%= c.name %></h3>
                <p class="text-gray-500 text-sm mb-1"><span class="font-medium text-gray-700">Email:</span> <%= c.email %></p>
                <p class="text-gray-500 text-sm mb-1"><span class="font-medium text-gray-700">Qualification:</span> <%= c.qualifications %></p>
                <p class="text-gray-500 text-sm"><span class="font-medium text-gray-700">Specialization:</span> <%= c.specialization.charAt(0).toUpperCase() + c.specialization.slice(1) %></p>
              </div>

              <!-- Day Availability Status -->
              <div class="mb-4">
                <% if (hasAvailableSlots) { %>
                  <div class="flex items-center mb-2">
                    <span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                    <span class="text-sm font-medium text-green-700">Available on <%= dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1) %></span>
                  </div>
                <% } else { %>
                  <div class="flex items-center mb-2">
                    <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                    <span class="text-sm font-medium text-red-700">Not available on <%= dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1) %></span>
                  </div>
                <% } %>
              </div>

              <!-- Available Slots -->
              <% if (hasAvailableSlots) { %>
                <div class="mb-4">
                  <h4 class="text-sm font-medium text-gray-700 mb-2">Available Slots for <%= dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1) %>:</h4>
                  <div class="grid grid-cols-2 gap-2">
                    <% availableSlotsForDay.forEach(slot => { %>
                      <% 
                        const isBooked = counsellorBookedSlots.has(slot);
                        const isBookedByUser = userBookedSlots.includes(slot);
                      %>
                      <div class="text-xs p-2 rounded border text-center
                                  <%= isBookedByUser ? 'bg-green-100 border-green-300 text-green-800' 
                                    : isBooked ? 'bg-red-100 border-red-300 text-red-800' 
                                    : 'bg-gray-100 border-gray-300 text-gray-800' %>">
                        <%= slot %>
                        <% if (isBookedByUser) { %>
                          <br><span class="text-green-600">(Your booking)</span>
                        <% } else if (isBooked) { %>
                          <br><span class="text-red-600">(Booked)</span>
                        <% } %>
                      </div>
                    <% }) %>
                  </div>
                </div>
              <% } else { %>
                <div class="mb-4">
                  <div class="bg-gray-100 border border-gray-300 rounded-lg p-3 text-center">
                    <p class="text-sm text-gray-600">No slots available on <%= dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1) %></p>
                    <p class="text-xs text-gray-500 mt-1">Try selecting a different date</p>
                  </div>
                </div>
              <% } %>

              <!-- Booking Form -->
              <% if (hasAvailableSlots) { %>
                <form action="/counsellors/book" method="POST" class="mt-auto space-y-3">
                  <input type="hidden" name="id" value="<%= c._id %>">
                  <input type="hidden" name="date" value="<%= selectedDate %>">

                  <select name="slot"
                          class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:outline-none"
                          required>
                    <option value="">Select a slot</option>
                    <% availableSlotsForDay.forEach(slot => { %>
                      <% 
                        const isBooked = counsellorBookedSlots.has(slot);
                        const isBookedByUser = userBookedSlots.includes(slot);
                      %>
                      <% if (!isBooked) { %>
                        <option value="<%= slot %>"><%= slot %></option>
                      <% } %>
                    <% }) %>
                    <% if (availableSlotsForDay.every(slot => counsellorBookedSlots.has(slot))) { %>
                      <option disabled>All slots booked</option>
                    <% } %>
                  </select>

                  <button type="submit"
                          class="w-full px-4 py-2 rounded-lg text-sm font-medium transition duration-200
                                 <%= availableSlotsForDay.every(slot => counsellorBookedSlots.has(slot)) 
                                   ? 'bg-gray-300 text-gray-600 cursor-not-allowed' 
                                   : 'bg-blue-600 hover:bg-blue-700 text-white shadow-sm hover:shadow-md' %>"
                          <%= availableSlotsForDay.every(slot => counsellorBookedSlots.has(slot)) ? "disabled" : "" %>>
                    <%= availableSlotsForDay.every(slot => counsellorBookedSlots.has(slot)) ? "All Slots Booked" : "Book Now" %>
                  </button>
                </form>
              <% } else { %>
                <div class="mt-auto">
                  <button type="button" disabled
                          class="w-full px-4 py-2 rounded-lg text-sm font-medium bg-gray-300 text-gray-600 cursor-not-allowed">
                    Not Available Today
                  </button>
                </div>
              <% } %>

              <!-- Dashboard Link -->
              <a href="/counsellors/counsellor/<%= c._id %>/dashboard?date=<%= selectedDate %>"
                 class="w-full block text-center mt-3 px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm hover:shadow-md transition">
                View Dashboard
              </a>

            </div>
          <% }) %>
        </div>
      <% } else { %>
        <!-- Empty State -->
        <div class="flex flex-col items-center justify-center py-16 text-center">
          <img src="https://cdn-icons-png.flaticon.com/512/4076/4076549.png" 
               alt="No counsellors" 
               class="w-28 mb-4 opacity-70">
          <p class="text-gray-500 text-lg">No counsellors available right now.</p>
        </div>
      <% } %>

    </main>
  </div>
</body>
</html>
